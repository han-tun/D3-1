<!DOCTYPE html>
<meta charset="utf-8">
<style>

.node {
  cursor: pointer;
}

.node:hover {
  stroke: #000;
  stroke-width: 1.5px;
}

.node--leaf {
  fill: white;
}

.label {
  font: 11px "Helvetica Neue", Helvetica, Arial, sans-serif;
  text-anchor: middle;
  text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff, 0 -1px 0 #fff;
}


</style>
<div>
   Grade <select id='Grade' multiple onchange="FilterChange(Grade)" ></select>
   Subject <select id='Subject' multiple onchange="FilterChange(Subject)"></select>
   Unit <select id='Unit' multiple onchange="FilterChange(Unit)"></select>
   Chapter <select id='Chapter' multiple onchange="FilterChange(Chapter)"></select>
   Topic <select id='Topic' multiple onchange="FilterChange(Topic)">></select>
</div>
<div> 
	Level-1<select id='Level1'> <option value='CooboTitles'>CooboTitles</option></select> 
	Level-2<select id='Level2'> <option value='Concept'>Concept</option><option value='Grade'>Grade</option></select> 
	Metric <select id='Metric'><option value='Scriptwriting'>Scriptwriting</option><option value='MediaFile'>MediaFile</option><option value='Production'>Production</option><option value='LengthofCoboo'>LengthofCoboo</option></select> 
</div>

<div id= 'PackCircle'> <svg id='PackCircleSVG' width="1400" height="1400"></svg> </div>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>



d3.csv("Taxonomy_new.csv", function(error, data) {
  if (error) throw error;

data_bk = data
loadFilters(data,'Basic')
circlepacking(data)
 
});

function FilterChange(filter)
{

data = FilterData()
circlepacking(data)

}

function FilterData()
{

var e = document.getElementById("Grade");
var GradeSel = e.options[e.selectedIndex].value;

var e = document.getElementById("Subject");
var SubjectSel = e.options[e.selectedIndex].value;

var e = document.getElementById("Unit");
var UnitSel = e.options[e.selectedIndex].value;

var e = document.getElementById("Chapter");
var ChapterSel = e.options[e.selectedIndex].value;

var e = document.getElementById("Topic");
var TopicSel = e.options[e.selectedIndex].value;

data = data_bk.filter(function(d) { return (d.Grade  == GradeSel || GradeSel == "All") && (d.Subject  == SubjectSel || SubjectSel == "All") && (d.Unit  == UnitSel || UnitSel == "All") && (d.Chapter  == ChapterSel || ChapterSel == "All")  && (d.Topic  == TopicSel || TopicSel == "All")  ;});

return(data)
}

function loadFilters(data,step)
{

	var Grade = []
	var Subject = []
	var Unit = []
	var Chapter = []
	var Topic = []

	for(var i=0; i<data.length; i++) {
		if(Grade.indexOf(data[i].Grade) ===  -1){Grade.push( data[i].Grade )}
		if(Subject.indexOf(data[i].Subject) ===  -1){Subject.push( data[i].Subject )}
		if(Unit.indexOf(data[i].Unit) ===  -1){Unit.push( data[i].Unit )}
		if(Chapter.indexOf(data[i].Chapter) ===  -1){Chapter.push( data[i].Chapter   )}
		if(Topic.indexOf(data[i].Topic) ===  -1){Topic.push( data[i].Topic )}
	} 


	var selectBox = document.getElementById('Grade');
	selectBox.options.add( new Option( "All", "All" , "TRUE") );
	for(var i = 0, l = Grade.length; i < l; i++){
	  selectBox.options.add( new Option(Grade[i], Grade[i]) );
	}
	selectBox.value = "All"
	

	
	var selectBox = document.getElementById('Subject');
	selectBox.options.add( new Option( "All", "All" , "TRUE") );
	for(var i = 0, l = Subject.length; i < l; i++){
	  selectBox.options.add( new Option(Subject[i], Subject[i]) );
	}
	selectBox.value = "All"
	
	var selectBox = document.getElementById('Unit');
	selectBox.options.add( new Option( "All", "All" , "TRUE") );
	for(var i = 0, l = Unit.length; i < l; i++){
	  selectBox.options.add( new Option(Unit[i], Unit[i]) );
	}
	selectBox.value = "All"
	
	var selectBox = document.getElementById('Chapter');
	selectBox.options.add( new Option( "All", "All" , "TRUE") );
	for(var i = 0, l = Chapter.length; i < l; i++){
	  selectBox.options.add( new Option(Chapter[i], Chapter[i]) );
	}
	selectBox.value = "All"
	
	var selectBox = document.getElementById('Topic');
	selectBox.options.add( new Option( "All", "All" , "TRUE") );
	for(var i = 0, l = Topic.length; i < l; i++){
	  selectBox.options.add( new Option(Topic[i], Topic[i]) );
	}
	selectBox.value = "All"
	
	
}

function circlepacking(data){

d3.select("#PackCircle").select("svg").selectAll("*").remove();

var svg = d3.select("#PackCircle").select("svg"),
    margin = 20,
    diameter = +svg.attr("width"),
    g = svg.append("g").attr("transform", "translate(" + diameter / 2 + "," + diameter / 2 + ")");

var color = d3.scaleLinear()
    .domain([-1, 5])
    .range(["hsl(152,80%,80%)", "hsl(228,30%,40%)"])
    .interpolate(d3.interpolateHcl);

var pack = d3.pack()
    .size([diameter - margin, diameter - margin])
    .padding(2);

	/*Chart Parameters*/
	{	
		var e = document.getElementById("Metric");
		var MericSel = e.options[e.selectedIndex].value;

		for(i=0; i< data.length; i++)
		{
		if(MericSel == "Scriptwriting"){data[i]['Metric'] = data[i].Scriptwriting}
		if(MericSel == "MediaFile"){data[i]['Metric'] = data[i].MediaFile}
		if(MericSel == "Production"){data[i]['Metric'] = data[i].Production}
		if(MericSel == "LengthofCoboo"){data[i]['Metric'] = data[i].LengthofCoboo}
		}
	}
	
var nested = 
	d3.nest()
  .key(function(d) { return d.CooboTitles; })
  .rollup(function(v) {
     return {
	 "children": v.map(function(v1) {return {"name": v1.Concept, "size": +v1.Metric };}),
	 "name":v[0].CooboTitles
	}
	
  }).entries(data);
  
 
 var root = {"name":"embibe", "children": []};
		for(var i=0; i<nested.length; i++) {
			root.children.push(nested[i].value);
		} 
		
  root = d3.hierarchy(root)
      .sum(function(d) { return d.size; })
      .sort(function(a, b) { return b.value - a.value; });

  
  var focus = root,
      nodes = pack(root).descendants(),
      view;

  var tooltip = d3.select("body")
	.append("div")
	.style("position", "absolute")
	.style("z-index", "10")
	.style("visibility", "hidden")
	
  var circle = g.selectAll("circle")
    .data(nodes)
    .enter().append("circle")
      .attr("class", function(d) { return d.parent ? d.children ? "node" : "node node--leaf" : "node node--root"; })
      .style("fill", function(d) { return d.children ? color(d.depth) : null; })
      .on("click", function(d) { if (focus !== d) zoom(d), d3.event.stopPropagation(); })
	   .on("mouseover", function(d){return tooltip.text(d.data.name).style("visibility", "visible");})
	.on("mousemove", function(){return tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");})
	.on("mouseout", function(){return tooltip.style("visibility", "hidden");});
	  ;

  var text = g.selectAll("text")
    .data(nodes)
    .enter().append("text")
      .attr("class", "label")
      .style("fill-opacity", function(d) { return d.parent === root ? 1 : 0; })
      .style("display", function(d) { return d.parent === root ? "inline" : "none"; })
      .text(function(d) { return d.data.name; });

  var node = g.selectAll("circle,text");

  svg
      .style("background", color(-1))
      .on("click", function() { zoom(root); });

  zoomTo([root.x, root.y, root.r * 2 + margin]);

  function zoom(d) {
    var focus0 = focus; focus = d;

    var transition = d3.transition()
        .duration(d3.event.altKey ? 7500 : 750)
        .tween("zoom", function(d) {
          var i = d3.interpolateZoom(view, [focus.x, focus.y, focus.r * 2 + margin]);
          return function(t) { zoomTo(i(t)); };
        });

    transition.selectAll("text")
      .filter(function(d) { return d.parent === focus || this.style.display === "inline"; })
        .style("fill-opacity", function(d) { return d.parent === focus ? 1 : 0; })
        .on("start", function(d) { if (d.parent === focus) this.style.display = "inline"; })
        .on("end", function(d) { if (d.parent !== focus) this.style.display = "none"; });
  }

  function zoomTo(v) {
    var k = diameter / v[2]; view = v;
    node.attr("transform", function(d) { return "translate(" + (d.x - v[0]) * k + "," + (d.y - v[1]) * k + ")"; });
    circle.attr("r", function(d) { return d.r * k; });
  }
}
</script>
